// packages/database/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ═══════════════════════════════════════════════════════════════
// USER MANAGEMENT
// ═══════════════════════════════════════════════════════════════

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  phone         String?   @unique
  
  // Profile
  firstName     String?
  lastName      String?
  dateOfBirth   DateTime?
  ssnLast4      String?
  
  // Auth
  passwordHash  String
  role          UserRole  @default(CLIENT)
  status        UserStatus @default(ACTIVE)
  isVerified    Boolean   @default(false)
  
  // Relationships
  addresses     Address[]
  creditReports CreditReport[]
  disputes      Dispute[]
  documents     Document[]
  notifications Notification[]
  subscription  Subscription?
  payments      Payment[]
  notes         Note[]
  activities    Activity[]
  
  // Affiliate
  affiliate     Affiliate?
  referredBy    String?   // Code of affiliate who referred this user
  
  // Blueprint Audit System
  blueprintAudits BlueprintAudit[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("users")
}

enum UserRole {
  CLIENT
  ADMIN
  SUPER_ADMIN
  AFFILIATE
  PARTNER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  ARCHIVED
}

model Address {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  street        String
  city          String
  state         String
  zipCode       String
  country       String    @default("US")
  
  isPrimary     Boolean   @default(false)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("addresses")
}

// ═══════════════════════════════════════════════════════════════
// NOTIFICATIONS
// ═══════════════════════════════════════════════════════════════

model Notification {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title         String
  message       String
  type          NotificationType
  read          Boolean   @default(false)
  
  createdAt     DateTime  @default(now())
  
  @@map("notifications")
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  DISPUTE_UPDATE
  SCORE_UPDATE
  BILLING
}

// ═══════════════════════════════════════════════════════════════
// CREDIT REPORT DATA
// ═══════════════════════════════════════════════════════════════

model CreditReport {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Monitoring Service
  provider        CreditProvider // MY_FREE_SCORE_NOW, IDENTITY_IQ, ETC.
  externalId      String?   // ID in the provider's system
  
  // Scores
  transunionScore Int?
  equifaxScore    Int?
  experianScore   Int?
  
  // Raw Data
  reportDate      DateTime
  nextUpdateDate  DateTime?
  rawJson         Json?     // Full raw JSON dump from provider
  
  // Parsed Items
  tradelines      Tradeline[]
  inquiries       Inquiry[]
  publicRecords   PublicRecord[]
  
  // Blueprint Audit System
  blueprintAudits BlueprintAudit[]
  
  createdAt       DateTime  @default(now())
  
  @@map("credit_reports")
}

enum CreditProvider {
  MY_FREE_SCORE_NOW
  IDENTITY_IQ
  SMART_CREDIT
  AUTO_PULL
}

model Tradeline {
  id                    String    @id @default(cuid())
  creditReportId        String
  creditReport          CreditReport @relation(fields: [creditReportId], references: [id], onDelete: Cascade)
  
  // Core Info
  creditorName          String
  accountNumber         String?   // Masked usually
  accountType           String?   // Revolving, Installment, etc.
  accountStatus         String?   // Open, Closed, Collections, etc.
  
  // Financials
  currentBalance        Decimal?
  creditLimit           Decimal?
  monthlyPayment        Decimal?
  pastDueAmount         Decimal?
  
  // Dates
  dateOpened            DateTime?
  dateReported          DateTime?
  dateLastActive        DateTime?
  dateOfFirstDelinquency DateTime? // Crucial for disputes
  
  // Payment History
  paymentHistory        String?   // Encoded string or JSON
  late30Count           Int       @default(0)
  late60Count           Int       @default(0)
  late90Count           Int       @default(0)
  
  // Remarks
  remarks               String?
  
  // Analysis
  isNegative            Boolean   @default(false)
  negativeReason        String?   // "Late Payment", "Collection", "Charge Off"
  
  // Ownership
  accountOwnership      String?   // Individual, Joint, Authorized User
  
  // Bureau Data
  bureau                Bureau
  
  // Relations to other systems
  disputeItems          DisputeItem[]
  auditItems            AuditItem[]
  
  @@map("tradelines")
}

enum Bureau {
  TRANSUNION
  EQUIFAX
  EXPERIAN
}

model Inquiry {
  id              String    @id @default(cuid())
  creditReportId  String
  creditReport    CreditReport @relation(fields: [creditReportId], references: [id], onDelete: Cascade)
  
  creditorName    String
  inquiryDate     DateTime
  bureau          Bureau
  inquiryType     String?   // Hard, Soft
  
  disputeItems    DisputeItem[]
  auditItems      AuditItem[]
  
  @@map("inquiries")
}

model PublicRecord {
  id              String    @id @default(cuid())
  creditReportId  String
  creditReport    CreditReport @relation(fields: [creditReportId], references: [id], onDelete: Cascade)
  
  recordType      String    // Bankruptcy, Judgment, Lien
  filingDate      DateTime?
  referenceNumber String?
  courtName       String?
  amount          Decimal?
  status          String?
  bureau          Bureau
  
  disputeItems    DisputeItem[]
  auditItems      AuditItem[]
  
  @@map("public_records")
}

// ═══════════════════════════════════════════════════════════════
// DISPUTE ENGINE
// ═══════════════════════════════════════════════════════════════

model Dispute {
  id              String      @id @default(cuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Current Status
  status          DisputeStatus @default(PENDING)
  round           Int         @default(1)
  
  // Generated Letters
  letters         GeneratedLetter[]
  
  // Items in this dispute round
  items           DisputeItem[]
  
  // Linked Document (The generated PDF)
  documents       Document[]
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@map("disputes")
}

model DisputeItem {
  id              String      @id @default(cuid())
  disputeId       String
  dispute         Dispute     @relation(fields: [disputeId], references: [id], onDelete: Cascade)
  
  // What is being disputed?
  type            DisputeType
  
  // Link to raw data
  tradelineId     String?
  tradeline       Tradeline?  @relation(fields: [tradelineId], references: [id])
  inquiryId       String?
  inquiry         Inquiry?    @relation(fields: [inquiryId], references: [id])
  publicRecordId  String?
  publicRecord    PublicRecord? @relation(fields: [publicRecordId], references: [id])
  
  // Dispute Logic
  reason          DisputeReason
  customReason    String?
  instruction     String?     // Specific instruction for AI generator
  
  // Outcome
  status          DisputeStatus @default(PENDING)
  outcome         DisputeOutcome?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@map("dispute_items")
}

model GeneratedLetter {
  id              String      @id @default(cuid())
  disputeId       String
  dispute         Dispute     @relation(fields: [disputeId], references: [id], onDelete: Cascade)
  
  bureau          Bureau
  content         String      @db.Text
  letterType      LetterType
  
  sentAt          DateTime?
  trackingNumber  String?
  deliveryStatus  String?
  
  @@map("generated_letters")
}

enum DisputeType {
  TRADELINE
  INQUIRY
  PUBLIC_RECORD
  PERSONAL_INFO
}

enum DisputeReason {
  NOT_MY_ACCOUNT
  ACCOUNT_CLOSED
  PAID_IN_FULL
  INCORRECT_BALANCE
  INCORRECT_PAYMENT_HISTORY
  INCORRECT_DATES
  DUPLICATE_ACCOUNT
  IDENTITY_THEFT
  MIXED_FILE
  OUTDATED_INFO
  NEVER_LATE
  INCORRECT_STATUS
  UNAUTHORIZED_INQUIRY
  OTHER
}

enum LetterType {
  INITIAL_DISPUTE
  FOLLOW_UP
  METHOD_OF_VERIFICATION
  PROCEDURAL_REQUEST
  DEBT_VALIDATION
  CEASE_AND_DESIST
  GOODWILL
  PAY_FOR_DELETE
  EARLY_EXCLUSION
  FACTUAL_DISPUTE
}

enum DeliveryMethod {
  CERTIFIED_MAIL
  REGULAR_MAIL
  ONLINE_PORTAL
  FAX
}

enum DisputeStatus {
  PENDING
  LETTER_GENERATED
  SENT
  IN_REVIEW
  RESPONSE_RECEIVED
  COMPLETED
  ESCALATED
}

enum ResponseType {
  VERIFIED
  DELETED
  UPDATED
  NO_RESPONSE
  FRIVOLOUS
  REINVESTIGATION
}

enum DisputeOutcome {
  DELETED
  CORRECTED
  VERIFIED_ACCURATE
  NO_RESPONSE_DELETED
  IN_PROGRESS
  ESCALATED_TO_CFPB
}

// ═══════════════════════════════════════════════════════════════
// DOCUMENTS
// ═══════════════════════════════════════════════════════════════

model Document {
  id              String          @id @default(cuid())
  userId          String
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  disputeId       String?
  dispute         Dispute?        @relation(fields: [disputeId], references: [id])
  
  // File info
  name            String
  type            DocumentType
  mimeType        String
  size            Int
  url             String
  
  // Metadata
  uploadedAt      DateTime        @default(now())
  
  @@map("documents")
}

enum DocumentType {
  ID_FRONT
  ID_BACK
  SSN_CARD
  UTILITY_BILL
  DISPUTE_LETTER
  RESPONSE_LETTER
  CREDIT_REPORT
  SIGNED_CONTRACT
  OTHER
}

// ═══════════════════════════════════════════════════════════════
// PAYMENTS & SUBSCRIPTIONS
// ═══════════════════════════════════════════════════════════════

model Subscription {
  id                String            @id @default(cuid())
  userId            String            @unique
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Plan details
  planId            String
  plan              Plan              @relation(fields: [planId], references: [id])
  
  // Stripe
  stripeCustomerId      String?
  stripeSubscriptionId  String?
  stripePriceId         String?
  
  // Status
  status            SubscriptionStatus
  
  // Dates
  startDate         DateTime
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  canceledAt        DateTime?
  endedAt           DateTime?
  
  // Trial
  trialStart        DateTime?
  trialEnd          DateTime?
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@map("subscriptions")
}

model Plan {
  id              String          @id @default(cuid())
  name            String
  description     String?
  
  // Pricing
  price           Decimal
  interval        PlanInterval
  
  // Features
  disputesPerMonth    Int
  bureausIncluded     Int         @default(3)
  creditMonitoring    Boolean     @default(true)
  prioritySupport     Boolean     @default(false)
  
  // Stripe
  stripePriceId   String?
  
  // Status
  active          Boolean         @default(true)
  
  subscriptions   Subscription[]
  
  @@map("plans")
}

model Payment {
  id              String          @id @default(cuid())
  userId          String
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Amount
  amount          Decimal
  currency        String          @default("USD")
  
  // Stripe
  stripePaymentIntentId String?
  stripeChargeId        String?
  
  // Status
  status          PaymentStatus
  
  // Metadata
  description     String?
  
  createdAt       DateTime        @default(now())
  
  @@map("payments")
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
}

enum PlanInterval {
  MONTHLY
  YEARLY
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

// ═══════════════════════════════════════════════════════════════
// CRM FEATURES
// ═══════════════════════════════════════════════════════════════

model Note {
  id              String          @id @default(cuid())
  userId          String
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  content         String          @db.Text
  createdBy       String          // Admin user ID
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@map("notes")
}

model Activity {
  id              String          @id @default(cuid())
  userId          String
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type            ActivityType
  description     String
  metadata        Json?
  
  createdAt       DateTime        @default(now())
  
  @@map("activities")
}

enum ActivityType {
  SIGNUP
  LOGIN
  CREDIT_PULL
  DISPUTE_CREATED
  DISPUTE_SENT
  DISPUTE_RESPONSE
  PAYMENT
  DOCUMENT_UPLOAD
  STATUS_CHANGE
  NOTE_ADDED
  AUDIT_STARTED // New
}

// ═══════════════════════════════════════════════════════════════
// AFFILIATE TRACKING
// ═══════════════════════════════════════════════════════════════

model Affiliate {
  id              String          @id @default(cuid())
  userId          String          @unique
  
  // Affiliate details
  code            String          @unique
  commissionRate  Decimal         @default(0.10) // 10%
  
  // Stats
  totalReferrals  Int             @default(0)
  totalEarnings   Decimal         @default(0)
  
  // Payout info
  paypalEmail     String?
  
  createdAt       DateTime        @default(now())
  
  @@map("affiliates")
}

// ═══════════════════════════════════════════════════════════════
// EMAIL & SMS TEMPLATES
// ═══════════════════════════════════════════════════════════════

model EmailTemplate {
  id              String          @id @default(cuid())
  name            String          @unique
  subject         String
  body            String          @db.Text
  type            EmailType
  
  active          Boolean         @default(true)
  
  @@map("email_templates")
}

model SmsTemplate {
  id              String          @id @default(cuid())
  name            String          @unique
  body            String          @db.VarChar(160)
  type            SmsType
  
  active          Boolean         @default(true)
  
  @@map("sms_templates")
}

enum EmailType {
  WELCOME
  VERIFICATION
  PASSWORD_RESET
  DISPUTE_SENT
  DISPUTE_UPDATE
  PAYMENT_RECEIPT
  PAYMENT_FAILED
  SUBSCRIPTION_REMINDER
  MONTHLY_REPORT
}

enum SmsType {
  VERIFICATION
  DISPUTE_UPDATE
  PAYMENT_REMINDER
  APPOINTMENT_REMINDER
}

// ═══════════════════════════════════════════════════════════════
// BLUEPRINT AUDIT SYSTEM
// ═══════════════════════════════════════════════════════════════

model BlueprintAudit {
  id                    String    @id @default(cuid())
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  creditReportId        String
  creditReport          CreditReport @relation(fields: [creditReportId], references: [id])
  
  // Scores at time of audit
  transunionScore       Int?
  equifaxScore          Int?
  experianScore         Int?
  
  // Automated Analysis Results
  totalViolationsFound  Int       @default(0)
  utilizationPercentage Decimal?
  totalUtilizationBalance Decimal?
  totalCreditLimit      Decimal?
  amountToReach20Percent Decimal?
  positiveTradelineCount Int      @default(0)
  negativeItemCount     Int       @default(0)
  collectionCount       Int       @default(0)
  inquiryCount          Int       @default(0)
  
  // Flags
  needsStarterAccounts  Boolean   @default(false)
  needsRentalTradelines Boolean   @default(false)
  hasAuthorizedUserIssues Boolean @default(false)
  
  // Status
  status                AuditStatus @default(PENDING_REVIEW)
  reviewedBy            String?     // Admin user ID
  reviewedAt            DateTime?
  
  // Generated Documents
  clientBlueprintUrl    String?
  companyBlueprintUrl   String?
  
  // Relationships
  auditItems            AuditItem[]
  consultationForm      ConsultationForm?
  recommendations       AuditRecommendation[]
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  @@map("blueprint_audits")
}

model AuditItem {
  id                    String    @id @default(cuid())
  auditId               String
  audit                 BlueprintAudit @relation(fields: [auditId], references: [id], onDelete: Cascade)
  
  // Item Reference
  itemType              AuditItemType
  tradelineId           String?
  tradeline             Tradeline? @relation(fields: [tradelineId], references: [id])
  inquiryId             String?
  inquiry               Inquiry?  @relation(fields: [inquiryId], references: [id])
  publicRecordId        String?
  publicRecord          PublicRecord? @relation(fields: [publicRecordId], references: [id])
  
  // Item Details (cached for blueprint)
  creditorName          String
  accountNumber         String?
  bureau                Bureau
  accountType           String?
  currentBalance        Decimal?
  creditLimit           Decimal?
  utilizationPercent    Decimal?
  amountToReach20       Decimal?
  accountAge            Int?      // In months
  isAuthorizedUser      Boolean   @default(false)
  
  // Automated Detection
  detectedViolations    Json?     // Array of violation codes
  violationCount        Int       @default(0)
  isNegative            Boolean   @default(false)
  negativeReason        String?
  
  // Manual Resolution Selection
  resolution            ItemResolution?
  resolutionNotes       String?   @db.Text
  
  // Flags
  doNotDispute          Boolean   @default(false)
  doNotDisputeReason    String?
  priorityLevel         Int       @default(0)  // 1-5, 5 being highest
  
  // For Collections
  isSettleable          Boolean?
  estimatedSettlement   Decimal?
  originalCreditor      String?
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  @@map("audit_items")
}

model ConsultationForm {
  id                    String    @id @default(cuid())
  auditId               String    @unique
  audit                 BlueprintAudit @relation(fields: [auditId], references: [id], onDelete: Cascade)
  
  // Client Personal Info
  clientFirstName       String
  clientLastName        String
  clientEmail           String
  clientPhone           String
  clientAddress         String?
  clientCity            String?
  clientState           String?
  clientZip             String?
  clientDOB             DateTime?
  
  // Financial Situation
  employmentStatus      EmploymentStatus?
  monthlyIncome         Decimal?
  rentOrOwn             RentOrOwn?
  monthlyRent           Decimal?
  hasCheckingAccount    Boolean?
  hasSavingsAccount     Boolean?
  
  // Credit Goals
  primaryGoal           String?   // "Buy Home", "Get Car", "Lower Interest Rates", etc.
  timeframe             String?   // "3 months", "6 months", "1 year"
  targetScore           Int?
  
  // Current Situation
  hasBankruptcy         Boolean?
  bankruptcyType        String?
  bankruptcyDischargeDate DateTime?
  hasForeclosure        Boolean?
  hasRepossession       Boolean?
  hasIdentityTheft      Boolean?
  identityTheftDetails  String?   @db.Text
  
  // Rental History (for tradeline suggestion)
  currentlyRenting      Boolean?
  landlordName          String?
  landlordPhone         String?
  landlordEmail         String?
  rentAmount            Decimal?
  leaseStartDate        DateTime?
  paymentMethod         String?   // "Check", "Online", "Cash"
  
  // Notes
  consultantNotes       String?   @db.Text
  clientNotes           String?   @db.Text
  
  // Status
  completedAt           DateTime?
  completedBy           String?   // Admin user ID
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  @@map("consultation_forms")
}

model AuditRecommendation {
  id                    String    @id @default(cuid())
  auditId               String
  audit                 BlueprintAudit @relation(fields: [auditId], references: [id], onDelete: Cascade)
  
  type                  RecommendationType
  title                 String
  description           String    @db.Text
  priority              Int       @default(0)
  
  // For product recommendations
  productName           String?
  productUrl            String?   // Affiliate link
  estimatedImpact       String?   // "Could increase score by 20-40 points"
  
  // Tracking
  implemented           Boolean   @default(false)
  implementedAt         DateTime?
  
  createdAt             DateTime  @default(now())
  
  @@map("audit_recommendations")
}

model FCRAViolation {
  id                    String    @id @default(cuid())
  code                  String    @unique
  section               String    // "1681e", "1681i", etc.
  title                 String
  description           String    @db.Text
  severity              ViolationSeverity
  commonIndicators      Json?     // Array of detection patterns
  
  @@map("fcra_violations")
}

enum AuditStatus {
  PENDING_REVIEW
  IN_REVIEW
  COMPLETED
  BLUEPRINT_GENERATED
  ARCHIVED
}

enum AuditItemType {
  TRADELINE
  COLLECTION
  INQUIRY
  PUBLIC_RECORD
  PERSONAL_INFO
}

enum ItemResolution {
  GENERAL_DISPUTE
  FCRA_VIOLATION
  IDENTITY_THEFT
  DEBT_VALIDATION
  PAY_FOR_DELETE
  GOODWILL_LETTER
  AUTHORIZED_USER_REMOVAL
  SETTLEMENT_NEGOTIATION
  DO_NOT_DISPUTE
  MONITOR_ONLY
}

enum EmploymentStatus {
  EMPLOYED_FULL_TIME
  EMPLOYED_PART_TIME
  SELF_EMPLOYED
  UNEMPLOYED
  RETIRED
  DISABLED
  STUDENT
}

enum RentOrOwn {
  RENT
  OWN
  LIVE_WITH_FAMILY
  OTHER
}

enum RecommendationType {
  STARTER_LOAN
  SECURED_CREDIT_CARD
  CREDIT_BUILDER_LOAN
  RENTAL_TRADELINE
  AUTHORIZED_USER
  PAY_DOWN_BALANCE
  REMOVE_AU_ACCOUNT
  DISPUTE_ITEM
  DEBT_SETTLEMENT
  IDENTITY_PROTECTION
  COLLECTIONS // Added from code interpretation
  GENERAL // Added from code interpretation
}

enum ViolationSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}
